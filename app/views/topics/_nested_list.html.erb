<%
  def render_form_button(category, scope)
  %>
    <% case category.topic_type %>
    <% when 'family member' %>
      <button type="button" class="btn <%= button_color(scope.family_members, category) %> pull-right down-eight" value="<%= category.id %>" id="family-reason" onclick="renderFamilyMemberTopicForm($(this).val());">Add relationship details</button>
    <% when 'measurement' %>
      <button type="button" class="btn <%= button_color(scope.tests, category) %> pull-right down-eight" value="<%= category.id %>" id="test-reason" onclick="renderTestTopicForm($(this).val());">Add test details</button>
    <% when 'procedure' %>
      <button type="button" class="btn <%= button_color(scope.procedures, category) %> pull-right down-eight" value="<%= category.id %>" id="procedure-reason">Add procedure details</button>
    <% when 'complication' %>
      <button type="button" class="btn <%= button_color(scope.complications, category) %> pull-right down-eight" value="<%= category.id %>" id="complication-reason" onclick="renderComplicationTopicForm($(this).val());">Add details</button>
    <% when 'symptom' %>
      <button type="button" class="btn <%= button_color(scope.symptoms, category) %> pull-right down-eight" value="<%= category.id %>" id="symptom-reason">Add symptom details</button>
    <% when 'diagnosis' %>
      <%= button_to diagnoses_path(action: :create, topic_id: category.id, patient_id: @visit.patient_id, visit_id: @visit.id, note: "absence"), class: "btn btn-danger pull-right down-eight" do %>
        <span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
      <% end %>
      <%= button_to diagnoses_path(action: :create, topic_id: category.id, patient_id: @visit.patient_id, visit_id: @visit.id, note: "presence"), class: "btn btn-success pull-right down-eight" do %>
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
      <% end %>
    <% when 'medication' %>
      <button type="button" class="btn <%= button_color(scope.medications, category) %> pull-right down-eight" value="<%= category.id %>" id="med-reason" onclick="renderMedTopicForm($(this).val());">Add medication details</button>
    <% when 'stat' %>
      <button type="button" class="btn <%= button_color(scope.vitals, category) %> pull-right down-eight" value="<%= category.id %>" id="stat-reason" onclick="renderStatTopicForm($(this).val());">Add vitals details</button>
    <% end %>
<% end %>

<%
  def draw_tree(node)
    node.children.each do |child|
%>
        <% if child.leaf? %>
          <li class="list-group-item list-group-item-action">
            <%= child.name %>
            <% render_form_button(child, @nested_scope) %>
        </li>
        <% else %>
          <li class="panel list-group-item">
            <a id="heading_<%= child.id %>" data-toggle="collapse" role="tab" aria-expanded="true" aria-controls="link_<%= node.id %>" data-parent="#link_<%= child.parent_id %>" href="#link_<%= child.id %>">
              <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
              <%= child.name %>
            </a>
            <br />
            <ul id="link_<%= child.id %>" class="collapse list-group"><% draw_tree(child) %></ul>
        <% end %>
          </li>
<%
    end; nil
  end
%>
<div class="row">
  <div class="col-xs-6">
    <ul class="list-group" id="accordion1">
      <% discussion_topic.roots.each do |node| %>
        <% if node.leaf? %>
        <li class="list-group-item list-group-item-action"><%= node.name %></li>
        <% else %>
          <li class="panel list-group-item list-group-item-action">
            <a id="heading_<%= node.id %>" data-toggle="collapse" role="tab" aria-expanded="true" aria-controls="link_<%= node.id %>" data-parent="#accordion1" href="#link_<%= node.id %>">
              <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
              <%= node.name  %>
            </a>
            <br />
          <ul id="link_<%= node.id %>" class="collapse show list-group" role="tabpanel" aria-labelledby="heading_<%= node.id %>" ><%= draw_tree(node) %></ul>
          </li>
        <% end %>
      <% end %>
    </ul>
  </div>
  <div class="col-xs-6">
    <div class="form-hook"></div>
  </div>
</div>

<script>
  function renderProcedureTopicForm(int) {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'procedures/procedure_form', f: f %><hr />");
    $('input.procedure-response:last').val(int);
  };
  function renderComplicationTopicForm(int) {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'complications/complication_form', f: f %><hr />");
    $('input.complication-response:last').val(int);
  };
  function renderTestTopicForm(int) {
    console.log("test called")
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'visits/test', f: f %>");
    $('input.test-response:last').val(int);
  };
  function renderSymptomTopicForm() {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'visits/test', f: f %><hr />");
  };
  function renderDiagnosisTopicForm() {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'visits/diagnosis', f: f %><hr />");
  };
  function renderFamilyMemberTopicForm(int) {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'visits/family_member_form', f: f %><hr />");
    $('input.family-response:last').val(int);
  };
  function renderMedTopicForm(int) {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'visits/medication_form', f: f %><hr />");
    $('input.med-response:last').val(int);
  };
  function renderStatTopicForm(int) {
    $('.tab-pane.active').find('.form-hook').html("<%= j render 'topics/vital_form', f: f %><hr />");
    $('input.stat-response').val(int);
  };
</script>
