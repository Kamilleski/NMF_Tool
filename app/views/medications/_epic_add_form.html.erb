<div class="row">
  <div class="col-sm">
    <div class="input-group">
        <input type="text" class="form-control" id="epicMed" placeholder="Epic users: .MEDSCURRENT"/>
        <span class="input-group-btn">
          <button type="button" class="btn btn-primary" data-animation="false" data-toggle="modal" data-target="#medModal" onclick="parseMed($('#epicMed').val());">
            Add Medication
          </button>
        </span>
    </div>
  </div>
</div>
<div id="invisible" data-rubyvar="<%= @all_meds.map{|t| [t.name.downcase, t.id]}.to_h.to_json %>"></div>

<!-- Modal -->
<div class="modal fade" id="medModal" tabindex="-1" role="dialog" aria-labelledby="medModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="medModalLabel">Add Medication</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <%= f.fields_for :medications, @nested_scope.medications.build do |ff| %>
        <div class="modal-body">
          <%= render 'medications/med_form_body', ff: ff %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <%= ff.submit "Add Medications", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
<script>
function parseMed(str) {
  var medsArr = str.split("•  ")
  var medsJSON = []
  if (medsArr[0].includes('Current')) {
    medsArr.shift();
  }
  for (var i = 0; i < medsArr.length; i++) {
    commas = medsArr[i].split(', ')
    if (commas[0].includes('(')) {
      firstParen = commas[0].indexOf('(')
      secondParen = commas[0].indexOf(')')
      doseSpace = commas[0].indexOf(' ', secondParen + 2)
      lastSpace = commas[0].indexOf(' ', doseSpace + 1)
      medsJSON.push(
        {
          "name": commas[0].slice(0, firstParen - 1),
          "commonName": commas[0].slice(firstParen + 1, secondParen),
          "dose": commas[0].slice(secondParen + 2, doseSpace),
          "doseUnitOfMeas": commas[0].slice(doseSpace + 1, lastSpace),
          "dosageForm": commas[0].slice(lastSpace + 1, commas[0].length),
          "ingestionMethod": commas[1],
          "topicID": mapMed(commas[0].slice(0, firstParen - 1), commas[0].slice(firstParen + 1, secondParen), $('#invisible').data('rubyvar'))
        }
      )
    }
    else {
      medsJSON.push(
        {
          "medicationFormat": commas[0],
          "ingestionMethod": commas[1],
          "topicID": mapMed(commas[0], commas[0], $('#invisible').data('rubyvar'))
        }
      )
    }
  }
  console.log(medsJSON)
  for (var i = 0; i < medsJSON.length; i++) {
    if (medsJSON[i]['medicationFormat']) {
      $('#unParsedMedsTable').append(
        `<tr>
          <input value="<%= @visit.id %>" type="hidden" name="visit[medications_attributes][${i}][visit_id]" id="visit_medications_attributes_${i}_visit_id" />
          <input value="<%= @patient.id %>" type="hidden" name="visit[medications_attributes][${i}][patient_id]" id="visit_medications_attributes_${i}_visit_id" />
          <input value="${medsJSON[i]["topicID"]}" type="hidden" name="visit[medications_attributes][${i}][topic_id]" id="visit_medications_attributes_${i}_topic_id" />
          <input value="${medsJSON[i]["medicationFormat"]}" type="hidden" name="visit[medications_attributes][${i}][name]" id="visit_medications_attributes_${i}_name" />
          <input value="${medsJSON[i]["ingestionMethod"]}" type="hidden" name="visit[medications_attributes][${i}][ingestion_method]" id="visit_medications_attributes_${i}_ingestion_method" />
          <td>
            ${medsJSON[i]["medicationFormat"]}
          </td>
          <td>
            ${medsJSON[i]["ingestionMethod"]}
          </td>
          <td>
            ${medsJSON[i]["topicID"]}
          </td>
        </tr>`
      )
    }
    else {
      $('#parsedMedsTable').append(
        `<tr>
          <input value="<%= @visit.id %>" type="hidden" name="visit[medications_attributes][${i}][visit_id]" id="visit_medications_attributes_${i}_visit_id" />
          <input value="<%= @patient.id %>" type="hidden" name="visit[medications_attributes][${i}][patient_id]" id="visit_medications_attributes_${i}_visit_id" />
          <input value="${medsJSON[i]["topicID"]}" type="hidden" name="visit[medications_attributes][${i}][topic_id]" id="visit_medications_attributes_${i}_topic_id" />
          <input value="${medsJSON[i]["commonName"]}" type="hidden" name="visit[medications_attributes][${i}][common_name]" id="visit_medications_attributes_${i}_common_name" />
          <input value="${medsJSON[i]["name"]}" type="hidden" name="visit[medications_attributes][${i}][name]" id="visit_medications_attributes_${i}_name" />
          <input value="${medsJSON[i]["dose"]}" type="hidden" name="visit[medications_attributes][${i}][dose]" id="visit_medications_attributes_${i}_dose" />
          <input value="${medsJSON[i]["doseUnitOfMeas"]}" type="hidden" name="visit[medications_attributes][${i}][dose_unit_of_measurement]" id="visit_medications_attributes_${i}_dose_unit_of_measurement" />
          <input value="${medsJSON[i]["dosageForm"]}" type="hidden" name="visit[medications_attributes][${i}][dosage_form]" id="visit_medications_attributes_${i}_dosage_form" />
          <input value="${medsJSON[i]["ingestionMethod"]}" type="hidden" name="visit[medications_attributes][${i}][ingestion_method]" id="visit_medications_attributes_${i}_ingestion_method" />
          <td>
            ${medsJSON[i]["name"]} (${medsJSON[i]["commonName"]})
          </td>
          <td>
            ${medsJSON[i]["dose"]} ${medsJSON[i]["doseUnitOfMeas"]} ${medsJSON[i]["dosageForm"]}
          </td>
          <td>
            ${medsJSON[i]["ingestionMethod"]}
          </td>
          <td>
            ${medsJSON[i]["topicID"]}

            <input value="<%= @visit.id %>" type="hidden" name="visit[medications_attributes][${i}][visit_id]" id="visit_medications_attributes_${i}_visit_id" />
          </td>
        </tr>`
      );
    }
  }
};

// Current Outpatient Prescriptions:
// •  acetaminophen (TYLENOL) 500 mg tablet, take 500 mg by mouth every 6 hours as needed (migraine headaches), Disp: , Rfl:
// •  aspirin 81 mg enteric coated tablet, take 81 mg by mouth daily, Disp: , Rfl:
// •  atenolol (TENORMIN) 25 mg tablet, take 12.5 mg by mouth 2 times a day Currently pt is taking 1/4 tab BID due to low BP., Disp: , Rfl:
// •  BIOFLAVONOIDS PO, take 1,000 mg by mouth 2 times per week, Disp: , Rfl:
// •  cranberry juice LIQD, take by mouth every day, Disp: , Rfl:
// •  docusate (COLACE) 100 mg CAPS, take 1 Cap by mouth every day, Disp: , Rfl:
// •  fluorouracil (EFUDEX) 5 % cream, by Topical route 2 times a day To affected area as directed, Disp: , Rfl:
// •  warfarin (COUMADIN) 5 mg tablet, take 5 mg by mouth daily Adjust per INR results., Disp: , Rfl:

</script>
